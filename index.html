<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CoinRush üöÄ</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(ellipse at center, #0a0f1c 0%, #000000 100%);
      color: #00ffcc;
      overflow-x: hidden;
    }
    header {
      text-align: center;
      padding: 20px;
      font-size: 1.5em;
      color: #00ffcc;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background: rgba(0,255,204,0.05);
      border: 1px solid #00ffcc30;
      border-radius: 15px;
      box-shadow: 0 0 10px #00ffcc40;
    }
    .balance, .level, .referrals {
      margin: 10px 0;
      font-size: 1.2em;
    }
    button {
      width: 100%;
      padding: 15px;
      background-color: #00ffcc20;
      border: 1px solid #00ffcc80;
      color: #00ffcc;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #00ffcc40;
    }
    .leaderboard {
      margin-top: 20px;
    }
    .leaderboard h3 {
      text-align: center;
      margin-bottom: 10px;
    }
    .leaderboard ul {
      list-style: none;
      padding: 0;
    }
    .leaderboard li {
      padding: 8px;
      border-bottom: 1px solid #00ffcc30;
    }
    a {
      color: #00ffff;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <header>üöÄ Welcome, loading...</header>
  <div class="container">
    <div class="balance">Balance: <span id="balance">Loading...</span> $CRT</div>
    <div class="level">Level: <span id="level">Loading...</span></div>
    <div class="referrals">Referrals: <span id="referralCount">Loading...</span></div>
    <button id="mineBtn">‚õèÔ∏è Mine CRT</button>
    <p style="text-align:center; margin-top:15px;">
      Your Referral Link:<br>
      <a id="refLink" href="#">Generating...</a>
    </p>
    <div class="leaderboard">
      <h3>üèÜ Leaderboard</h3>
      <ul id="leaderboardList"></ul>
    </div>
  </div>

  <!-- Firebase + Telegram logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCcGHNRR8fhADXn06P9aFjMc80nU93cMSU",
      authDomain: "coinrush-token.firebaseapp.com",
      projectId: "coinrush-token",
      storageBucket: "coinrush-token.appspot.com",
      messagingSenderId: "159731574189",
      appId: "1:159731574189:web:b031a1e16cba09edb7ed24",
      measurementId: "G-ZCMGL2MX3L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Telegram Mini App integration
    let tg = window.Telegram?.WebApp;
    let userId, userName;

    if (tg?.initDataUnsafe?.user) {
      const user = tg.initDataUnsafe.user;
      userId = `tg_${user.id}`;
      userName = user.username ? `@${user.username}` : user.first_name;
    } else {
      userId = localStorage.getItem("coinrush_user") || "guest_" + Math.random().toString(36).substring(2, 10);
      localStorage.setItem("coinrush_user", userId);
      userName = "Guest";
    }

    document.querySelector("header").innerHTML = `üöÄ Welcome, ${userName}!`;

    const userDoc = doc(db, "users", userId);
    const params = new URLSearchParams(window.location.search);
    const ref = params.get("ref");

    // Referral logic
    if (ref && ref !== userId) {
      const refDoc = doc(db, "users", ref);
      getDoc(refDoc).then(async (snap) => {
        if (snap.exists()) {
          await updateDoc(refDoc, {
            balance: increment(100),
            referrals: increment(1),
          });
        }
      });
    }

    // Initialize new user if not exists
    async function initUser() {
      const snap = await getDoc(userDoc);
      if (!snap.exists()) {
        await setDoc(userDoc, {
          balance: 0,
          referrals: 0,
        });
      }
    }

    // UI updater
    async function updateUI() {
      const snap = await getDoc(userDoc);
      const data = snap.data();
      const balance = data.balance || 0;
      const referrals = data.referrals || 0;

      document.getElementById("balance").textContent = balance;
      document.getElementById("referralCount").textContent = referrals;

      let level = "1";
      if (balance >= 1000 && balance < 100000) level = "2";
      else if (balance >= 100000) level = "3";
      document.getElementById("level").textContent = level;

      const link = `${location.origin}${location.pathname}?ref=${userId}`;
      document.getElementById("refLink").href = link;
      document.getElementById("refLink").textContent = link;
    }

    // Mining logic
    let clicks = 0;
    const maxClicksPerDay = 10;
    const mineBtn = document.getElementById("mineBtn");

    mineBtn.addEventListener("click", async () => {
      if (clicks >= maxClicksPerDay) {
        alert("You've reached your daily mining limit!");
        return;
      }
      await updateDoc(userDoc, {
        balance: increment(10),
      });
      clicks++;
      updateUI();
    });

    // Leaderboard logic
    async function loadLeaderboard() {
      const q = query(collection(db, "users"), orderBy("balance", "desc"), limit(5));
      const snap = await getDocs(q);
      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";
      snap.forEach((doc, index) => {
        const d = doc.data();
        list.innerHTML += `<li>#${index + 1} - ${doc.id.slice(-5)}... - ${d.balance} CRT</li>`;
      });
    }

    // Daily login bonus
    const today = new Date().toDateString();
    const lastLoginKey = "coinrush_last_login_" + userId;
    const lastLogin = localStorage.getItem(lastLoginKey);
    if (lastLogin !== today) {
      await updateDoc(userDoc, {
        balance: increment(100),
      });
      localStorage.setItem(lastLoginKey, today);
      alert("üéâ You've received your 100 CRT daily login reward!");
    }

    // Run all logic
    await initUser();
    await updateUI();
    await loadLeaderboard();
  </script>
</body>
</html>
